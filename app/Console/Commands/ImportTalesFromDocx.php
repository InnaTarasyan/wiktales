<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use App\Models\Tale;
use App\Models\TaleSection;
use App\Services\DocxParser;

class ImportTalesFromDocx extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'tales:import';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Импорт сказок из .docx файлов в storage/tales';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $legacyDir = base_path('storage/tales');
        $appDir = storage_path('app/tales');
        $candidates = [];
        if (is_dir($legacyDir)) {
            $candidates = array_merge($candidates, glob($legacyDir . '/*.docx') ?: []);
        }
        if (is_dir($appDir)) {
            $candidates = array_merge($candidates, glob($appDir . '/*.docx') ?: []);
        }
        // de-duplicate
        $files = collect($candidates)->unique()->values();

        if ($files->isEmpty()) {
            $this->info('Файлы .docx не найдены в storage/tales или storage/app/tales');
            return self::SUCCESS;
        }

        $parser = app(DocxParser::class);

        foreach ($files as $fullPath) {
            $this->line("Импорт: {$fullPath}");

            try {
                $data = $parser->parse($fullPath);
            } catch (\Throwable $e) {
                $this->error("Ошибка парсинга {$fullPath}: " . $e->getMessage());
                continue;
            }

            $baseName = pathinfo($fullPath, PATHINFO_FILENAME);
            $proposedTitle = $this->getCorrectTitle($baseName, $data['title'] ?? '');
            $slug = Str::slug($proposedTitle !== '' ? $proposedTitle : $baseName);
            // Avoid generic titles causing collisions; ensure uniqueness across tales
            $ensureUnique = function (string $trySlug) use ($baseName, $fullPath) {
                $slugCandidate = $trySlug !== '' ? $trySlug : Str::slug($baseName);
                $original = $slugCandidate;
                $i = 1;
                while (\App\Models\Tale::where('slug', $slugCandidate)->exists()) {
                    $i++;
                    $slugCandidate = $original . '-' . $i;
                    if ($i > 50) { // fallback hard stop
                        $slugCandidate = Str::slug($baseName) . '-' . substr(md5($baseName), 0, 6);
                        break;
                    }
                }
                return $slugCandidate;
            };
            $slug = $ensureUnique($slug);

            $coverUrl = null;
            if (!empty($data['cover']) && !empty($data['cover']['data'])) {
                $ext = $data['cover']['extension'] ?? 'jpg';
                Storage::disk('public')->put("tales/covers/{$slug}-cover.{$ext}", $data['cover']['data']);
                $coverUrl = "/storage/tales/covers/{$slug}-cover.{$ext}";
            }

            // Get description for this tale
            $description = $this->getTaleDescription($proposedTitle);
            $meta = $data['meta'] ?? [];
            if ($description) {
                $meta['description'] = $description;
            }
            
            $tale = Tale::updateOrCreate(
                ['source_filename' => basename($fullPath)],
                [
                    'title' => $proposedTitle !== '' ? $proposedTitle : $baseName,
                    'slug' => $slug,
                    'cover_url' => $coverUrl,
                    'toc' => $data['toc'] ?? [],
                    'meta' => $meta,
                ]
            );

            if (!empty($data['sections'])) {
                $tale->sections()->delete();
                foreach ($data['sections'] as $index => $section) {
                    $tale->sections()->create([
                        'order' => $index + 1,
                        'title' => $section['title'] ?? null,
                        'anchor' => $section['anchor'] ?? null,
                        'body_html' => $section['body_html'] ?? null,
                        'body_text' => $section['body_text'] ?? null,
                    ]);
                }
            }
        }

        $this->info('Импорт завершен.');
        return self::SUCCESS;
    }

    /**
     * Get the correct title for a file based on filename mapping
     */
    private function getCorrectTitle(string $filename, string $extractedTitle): string
    {
        $titleMapping = [
            '1 Faun' => 'ФАВН',
            '2 Tanz der Empussa' => 'ТАНЕЦ    ЭМПУСЫ',
            '3 Volontären für Kirka' => 'КИРКИ',
            '4 Argonauten' => 'ARGONAUTEN',
            '5-Vandimenen Eiland' => 'VANDIMENEN EILAND',
            '1-Fortinbras ist gekommen' => 'FORTINBRAS IST GEKOMMEN',
            '1-Weiße Stirn. Grenze' => 'БЕЛОЛОБЫЙ. РУБЕЖ',
            '1.Im Gesetzkörper (Säule und Mond) ' => 'ЛУНА И СТОЛБ. В ТЕЛЕ ЗАКОНА',
            '2-Blauenstadt' => 'BLAUENSTADT',
            '2-Velichan' => 'ВЕЛИХАН',
            '2.Melisanda ' => 'МЕЛИСАНДА. ПОПЫТКА ОДНОЙ РЕАБИЛИТАЦИИ',
            '2.Драконья гора ' => 'Драконья Гора',
            '3-Blick werfen der Mond,Herr Oberst!' => 'ВЗГЛЯНЕМ НА ЛУНУ, ПОЛКОВНИК!',
            '3.Berchtesgaden ' => 'BERCHESTCADEN',
            '3.Пороги Луны ' => 'Пороги Луны',
            '4.Krähen Freiheit ' => ' ВОРОНЬЯ   СЛОБОДА',
            '4.Плесень в Храме ' => 'Плесень в Храме',
            '5.Anadyr ' => 'Anadyr',
            '5.Пленэр ' => 'Пленэр',
            '6.Малые формы ' => 'Малые формы',
            '7.Либретто ' => 'Либретто',
            '8.Романтический хулиган ' => 'Романтический хулиган',
            '1.Ритмы поднебесной ' => 'Ритмы поднебесной',
        ];

        // Check if we have a mapping for this filename (without extension)
        if (isset($titleMapping[$filename])) {
            return $titleMapping[$filename];
        }

        // Fallback to extracted title or filename
        return trim($extractedTitle) !== '' ? trim($extractedTitle) : $filename;
    }
    
    /**
     * Get description for a tale based on title
     */
    private function getTaleDescription(string $title): ?string
    {
        $descriptions = [
            'ФАВН' => 'Экспериментальная повесть Виктора Хоффа, исследующая мифологические архетипы в современном городском пространстве. Произведение сочетает элементы психологического реализма с мифологическими мотивами, создавая уникальный сплав древних образов и современной экзистенциальной проблематики. История разворачивается в хмуром утреннем пейзаже, где мифологический персонаж фавна сталкивается с реалиями современного мира, включая аэропорты и городскую инфраструктуру.',
            'ТАНЕЦ    ЭМПУСЫ' => 'Экспериментальная мифологическая проза, исследующая древнегреческие архетипы через призму современного сознания. Произведение обращается к образам эмпус — мифологических существ из греческой мифологии, известных своей двойственной природой. Текст сочетает архаические мифологические мотивы с современными литературными техниками, создавая многослойное повествование о столкновении древних сил с современной реальностью.',
            'КИРКИ' => 'Глубокая психологическая драма о женской судьбе и внутренней борьбе. Произведение исследует сложные взаимоотношения между персонажами через призму мифологических образов и современного психологического анализа. Текст сочетает элементы реализма с символическими мотивами, создавая пронзительное повествование о любви, утрате и поиске смысла.',
            'ARGONAUTEN' => 'Мощная мифологическая проза, переосмысливающая древнегреческие легенды о путешествии аргонавтов в современном контексте. Произведение исследует темы героизма, поиска золотого руна и внутреннего путешествия через образы лейтенанта и его духовных исканий. Текст сочетает архаические мифологические мотивы с современными психологическими и философскими измерениями.',
            'FORTINBRAS IST GEKOMMEN' => 'Мощная драматическая интерпретация шекспировского "Гамлета" в современной немецкой прозе. Произведение исследует темы власти, мести и судьбы через призму персонажей принца, Гертруды и Лаэрта. Текст разворачивается в символических пространствах — зеркальной зале, лягушачьем гроте и черной башне, создавая многослойную структуру повествования.',
            'БЕЛОЛОБЫЙ. РУБЕЖ' => 'Экзистенциальная проза о границах и пограничье человеческого бытия. Произведение исследует темы идентичности, принадлежности и отчуждения через образы пограничных пространств и состояний. Текст создает атмосферу внутреннего напряжения и поиска своего места в мире.',
            'ЛУНА И СТОЛБ. В ТЕЛЕ ЗАКОНА' => 'Философская проза о власти символов и структур в человеческой жизни. Произведение исследует темы порядка, закона и их влияния на индивидуальное существование через образы архитектурных и космических элементов. Текст сочетает метафизические размышления с конкретными образами, создавая многослойное повествование.',
            'BLAUENSTADT' => 'Урбанистическая повесть о городском пространстве и его обитателях. Произведение исследует темы одиночества в толпе, отчуждения и поиска человеческих связей в современном мегаполисе. Текст создает атмосферу синего города, где персональные драмы разворачиваются на фоне безличных архитектурных масс.',
            'ВЕЛИХАН' => 'Психологическая повесть о внутреннем конфликте и поиске себя. Произведение исследует сложные взаимоотношения между героем и его окружением, раскрывая глубины человеческой души через психологический анализ и символические образы.',
            'МЕЛИСАНДА. ПОПЫТКА ОДНОЙ РЕАБИЛИТАЦИИ' => 'Глубокая психологическая драма, представляющая попытку реабилитации образа Мелисанды из пьесы Мориса Метерлинка "Пеллеас и Мелисанда". Произведение исследует сложную психологию женского персонажа, стоящего у обрыва и облокотившегося на металлические перила. Текст сочетает элементы символизма с современным психологическим анализом.',
            'Драконья Гора' => 'Изящная китайская пейзажная поэзия, воспевающая красоту природы и глубину философских размышлений. Стихи создают атмосферу глухого молчания рассвета, где мостик на рисовом поле становится символом связи между мирами. Поэзия исследует темы свежести утреннего солнца и абрикосового сада.',
            'ВЗГЛЯНЕМ НА ЛУНУ, ПОЛКОВНИК!' => 'Драматическая повесть с элементами мистики и военной тематики. Произведение исследует темы власти, подчинения и внутреннего сопротивления через образы военной иерархии и лунной символики. Текст создает атмосферу напряжения и поиска истины.',
            'BERCHESTCADEN' => 'Историческая проза, размышляющая о прошлом и его влиянии на настоящее через призму немецкой истории. Произведение исследует темы памяти, ответственности и наследия прошлого. Текст создает атмосферу рефлексии о исторических событиях и их последствиях для современного общества.',
            'Пороги Луны' => 'Лирическая поэзия, исследующая темы одиночества и поиска смысла через образы ночного пейзажа и лунного света. Стихи создают атмосферу таинственности и меланхолии, где черная луна изумрудного пруда становится символом глубинных переживаний. Поэзия исследует темы любви, потери и духовного поиска.',
            ' ВОРОНЬЯ   СЛОБОДА' => 'Философская повесть о свободе и ее границах. Произведение исследует темы воли, выбора и ответственности через образы вороньего мира и символики свободы. Текст сочетает конкретные образы с абстрактными размышлениями о природе человеческой свободы.',
            'Плесень в Храме' => 'Глубокая философская проза о духовном упадке и поиске истины в современном мире. Произведение исследует темы духовного кризиса, где храм становится символом утраченных идеалов, а плесень — метафорой разложения духовных ценностей. Текст создает атмосферу гладиаторской борьбы на арене жизни.',
            'Anadyr' => 'Полярная повесть о жизни в экстремальных условиях. Произведение исследует темы выживания, человеческой стойкости и взаимоотношений человека с суровой природой. Текст создает атмосферу холода, льда и сияния северного сияния.',
            'Пленэр' => 'Художественная повесть о живописи и восприятии мира. Произведение исследует темы искусства, красоты и способности видеть через образы пленэрной живописи. Текст создает атмосферу света, цвета и художественного восприятия реальности.',
            'Малые формы' => 'Изящная минималистичная поэзия, исследующая мгновения и вечность через краткие, но глубокие образы. Стихи демонстрируют мастерство сжатой формы, где каждое слово несет максимальную смысловую нагрузку. Произведение исследует темы времени, памяти и человеческих переживаний.',
            'Либретто' => 'Драматическое произведение в оперном формате. Либретто исследует темы страсти, любви, ревности и судьбы через оперные образы и музыкальную драматургию. Текст создает атмосферу оперного театра с его эмоциональной напряженностью.',
            'Романтический хулиган' => 'Романтическая повесть с элементами бунтарства. Произведение исследует темы любви, свободы и неподчинения общественным нормам через образы романтического героя-бунтаря. Текст сочетает романтические мотивы с современным звучанием.',
            'Ритмы поднебесной' => 'Сборник классической китайской поэзии, представляющий глубокие философские размышления о природе, времени и человеческом существовании. Поэзия отражает традиционные китайские эстетические принципы, где природа становится зеркалом человеческой души. Стихи исследуют темы гармонии с природой и цикличности времен года.',
            'VANDIMENEN EILAND' => 'Приключенческая повесть о путешествии к таинственному острову. Произведение исследует темы открытия нового, встречи с неизвестным и личностного роста через образы морского путешествия и островных приключений. Текст создает атмосферу романтики и опасности.',
        ];

        return $descriptions[$title] ?? null;
    }
}
